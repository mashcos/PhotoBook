<p-toast></p-toast>

<div class="admin-container">
  <h1 class="page-title">
    <i class="pi pi-cog"></i>
    Photo Admin
  </h1>

  <!-- Toolbar -->
  <div class="admin-toolbar">
    @if (isFileSystemSupported()) {
      <p-button
        label="Select Directory"
        icon="pi pi-folder-open"
        (onClick)="selectDirectory()"
        [loading]="isLoading()"
      ></p-button>
      <p-button
        label="Save to File"
        icon="pi pi-save"
        severity="success"
        (onClick)="saveToFile()"
        [loading]="isLoading()"
      ></p-button>
    } @else {
      <div class="api-warning">
        <i class="pi pi-exclamation-triangle"></i>
        <span>File System Access API is not supported in this browser. Use Chrome or Edge for local file management.</span>
      </div>
    }
  </div>

  <!-- Photos Table -->
  <p-table
    #dt
    [value]="editablePhotos()"
    [(expandedRowKeys)]="expandedRows"
    dataKey="id"
    [tableStyle]="{'min-width': '100%'}"
    class="p-datatable-sm"
    [scrollable]="true"
    scrollHeight="calc(100vh - 350px)"
    (onRowExpand)="onRowExpand($event)"
    (onRowCollapse)="onRowCollapse($event)"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem"></th>
        <th style="width: 80px">Preview</th>
        <th style="min-width: 150px" pSortableColumn="title">Title <p-sortIcon field="title"></p-sortIcon></th>
        <th style="min-width: 200px">Description</th>
        <th style="width: 120px" pSortableColumn="date">Date <p-sortIcon field="date"></p-sortIcon></th>
        <th style="min-width: 150px">Location</th>
        <th style="width: 100px">Privacy</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-photo let-expanded="expanded">
      <tr>
        <td>
          <button type="button" pButton pRipple (click)="dt.toggleRow(photo)" class="p-button-text p-button-rounded p-button-plain" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
        </td>
        <td>
          <div class="preview-image">
            <img [src]="photo.src" [alt]="photo.title" />
          </div>
        </td>
        <td>{{ photo.title }}</td>
        <td>{{ photo.description }}</td>
        <td>{{ photo.date | date:'shortDate' }}</td>
        <td>{{ photo.location.name || '-' }}</td>
        <td>
          @if (photo.isPrivacyProtected) {
            <i class="pi pi-lock" style="color: #e65100;"></i>
          } @else {
            <i class="pi pi-lock-open" style="color: #4caf50;"></i>
          }
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="rowexpansion" let-photo>
      <tr>
        <td colspan="7" class="p-0">
          <div *ngIf="clonedPhotos[photo.id] as editingPhoto" class="expanded-row-wrapper p-3 surface-ground">
            <div class="expanded-content flex flex-column md:flex-row gap-4">
              <!-- Large Image -->
              <div class="expanded-image-section md:w-6 w-full">
                <div class="image-card surface-card p-3 border-round shadow-1 h-full flex align-items-center justify-content-center">
                  <img [src]="editingPhoto.src" [alt]="editingPhoto.title" class="expanded-image w-full border-round" style="object-fit: contain; max-height: 500px;" />
                </div>
              </div>

              <!-- Edit Form -->
              <div class="expanded-form-section md:w-6 w-full">
                <div class="surface-card p-4 border-round shadow-1">
                  <h3 class="mt-0 mb-3 text-900">Edit Details</h3>

                  <div class="field mb-3">
                    <label for="title" class="font-bold block mb-2 text-700">Title</label>
                    <input pInputText id="title" [(ngModel)]="editingPhoto.title" class="w-full" />
                  </div>

                  <div class="field mb-3">
                    <label for="description" class="font-bold block mb-2 text-700">Description</label>
                    <textarea pTextarea id="description" [(ngModel)]="editingPhoto.description" rows="3" class="w-full"></textarea>
                  </div>

                  <div class="formgrid grid">
                    <div class="field col-12 md:col-6 mb-3">
                      <label for="date" class="font-bold block mb-2 text-700">Date</label>
                      <p-datepicker [(ngModel)]="editingPhoto.dateObj" [showTime]="true" dateFormat="yy-mm-dd" appendTo="body" styleClass="w-full" [style]="{'width':'100%'}"></p-datepicker>
                    </div>
                    <div class="field col-12 md:col-6 mb-3">
                      <label class="font-bold block mb-2 text-700">Categories</label>
                      <p-multiSelect [options]="categories()" [(ngModel)]="editingPhoto.categoryIds" optionLabel="label" optionValue="id" display="chip" [style]="{'width':'100%'}" appendTo="body"></p-multiSelect>
                    </div>
                  </div>

                  <div class="field mb-3">
                    <label class="font-bold block mb-2 text-700">Location</label>
                    <div class="p-inputgroup mb-2">
                      <span class="p-inputgroup-addon"><i class="pi pi-map-marker"></i></span>
                      <input pInputText placeholder="Location Name" [(ngModel)]="editingPhoto.location.name" />
                    </div>
                    <div class="formgrid grid">
                      <div class="field col-12 md:col-4 mb-2">
                        <p-inputNumber [(ngModel)]="editingPhoto.location.lat" mode="decimal" [minFractionDigits]="6" [maxFractionDigits]="6" placeholder="Latitude" styleClass="w-full" [style]="{'width': '100%'}" [title]="'Latitude'"></p-inputNumber>
                      </div>
                      <div class="field col-12 md:col-4 mb-2">
                        <p-inputNumber [(ngModel)]="editingPhoto.location.lng" mode="decimal" [minFractionDigits]="6" [maxFractionDigits]="6" placeholder="Longitude" styleClass="w-full" [style]="{'width': '100%'}" [title]="'Longitude'"></p-inputNumber>
                      </div>
                      <div class="field col-12 md:col-4 mb-2">
                        <p-button label="Select on Map" icon="pi pi-map" (onClick)="openMapSelector(photo)" styleClass="w-full" severity="secondary"></p-button>
                      </div>
                    </div>
                  </div>

                  <div class="field-checkbox mb-4">
                    <p-checkbox [(ngModel)]="editingPhoto.isPrivacyProtected" [binary]="true" inputId="privacy"></p-checkbox>
                    <label for="privacy" class="ml-2 text-700">Privacy Protected</label>
                  </div>

                  <div class="flex justify-content-end gap-2">
                    <p-button label="Cancel" icon="pi pi-times" severity="secondary" (onClick)="onRowEditCancel(photo)"></p-button>
                    <p-button label="Save Changes" icon="pi pi-check" (onClick)="onRowEditSave(photo)"></p-button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7" class="text-center p-4">
          <div class="empty-state">
            <i class="pi pi-images"></i>
            <p>No photos loaded. Select a directory or load from server.</p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>
