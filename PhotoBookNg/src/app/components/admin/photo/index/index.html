<p-toast></p-toast>
<p-dialog header="Select Location" [(visible)]="isMapSelectorVisible" [modal]="true"
  [style]="{ width: '90vw', maxWidth: '800px' }" [draggable]="false" [resizable]="false">
  @if (isMapSelectorVisible()) {
  <app-map-selector [initialLocation]="initialMapLocation()" (save)="onMapSave($event)"
    (cancel)="isMapSelectorVisible.set(false)"></app-map-selector>
  }
</p-dialog>

<div class="admin-container">
  <h1 class="page-title">
    <i class="pi pi-cog"></i>
    Photo Admin
  </h1>

  <!-- Bulk Actions Toolbar -->
  @if (selectedPhotos().length > 0) {
  <div class="bulk-toolbar fadein">
    <div class="flex align-items-center gap-3 flex-wrap">
      <span class="font-bold text-primary">{{ selectedPhotos().length }} Selected</span>

      <div class="flex align-items-center gap-2">
        <p-select [options]="categories()" [(ngModel)]="bulkCategory" optionLabel="categoryName" optionValue="id"
          placeholder="Add Category" [style]="{'width':'200px'}" appendTo="body" [showClear]="true"></p-select>
        <p-button label="Apply" icon="pi pi-check" size="small" (onClick)="applyBulkCategory()"
          [disabled]="!bulkCategory"></p-button>
      </div>

      <div class="flex align-items-center gap-2">
        <span class="p-input-icon-left">
          <i class="pi pi-map-marker"></i>
          <input pInputText placeholder="Set Location Name" [(ngModel)]="bulkLocationName" />
        </span>
        <p-button label="Apply" icon="pi pi-check" size="small" (onClick)="applyBulkLocationName()"
          [disabled]="!bulkLocationName"></p-button>
      </div>
    </div>
  </div>
  }

  <!-- Photos Table -->
  <p-table #dt [value]="editablePhotos()" [(selection)]="selectedPhotos" dataKey="id"
    [tableStyle]="{'min-width': '100%'}" class="p-datatable-sm" [scrollable]="true" scrollHeight="calc(100vh - 420px)"
    (onRowExpand)="onRowExpand($event)" (onRowCollapse)="onRowCollapse($event)" [expandedRowKeys]="expandedRows">
    <ng-template #header>
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th style="width: 3rem"></th>
        <th style="width: 80px">Preview</th>
        <th style="min-width: 150px" pSortableColumn="title">Title <p-sortIcon field="title"></p-sortIcon></th>
        <th style="min-width: 200px">Description</th>
        <th style="width: 120px" pSortableColumn="date">Date <p-sortIcon field="date"></p-sortIcon></th>
        <th style="min-width: 150px">Location</th>
        <th style="width: 100px">Privacy</th>
      </tr>
    </ng-template>
    <ng-template #body let-photo let-expanded="expanded">
      <tr>
        <td>
          <p-tableCheckbox [value]="photo"></p-tableCheckbox>
        </td>
        <td>
          <p-button type="button" pRipple [pRowToggler]="photo" class="p-button-text p-button-rounded p-button-plain"
            [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></p-button>
        </td>
        <td>
          <div class="preview-image">
            <img [src]="photo.filename! | imageSource" [alt]="photo.title" />
          </div>
        </td>
        <td>{{ photo.title }}</td>
        <td>{{ photo.description }}</td>
        <td>{{ photo.date | date:'shortDate' }}</td>
        <td>{{ (photo | locationName:locations()) || '-' }}</td>
        <td>
          @if (photo.isPrivacyProtected) {
          <i class="pi pi-lock" style="color: #e65100;"></i>
          } @else {
          <i class="pi pi-lock-open" style="color: #4caf50;"></i>
          }
        </td>
      </tr>
    </ng-template>

    <ng-template #expandedrow let-photo>
      <tr>
        <td colspan="8" class="p-0">
          @if (clonedPhotos[photo.id]; as editingPhoto) {
          <div class="expanded-row-wrapper p-3 surface-ground">
            <div class="expanded-content flex flex-column md:flex-row gap-4">
              <!-- Large Image -->
              <div class="expanded-image-section md:w-6 w-full">
                <div
                  class="image-card surface-card p-3 border-round shadow-1 h-full flex align-items-center justify-content-center">
                  <img [src]="editingPhoto.filename! | imageSource" [alt]="editingPhoto.title" class="expanded-image w-full border-round"
                    style="object-fit: contain; max-height: 500px;" />
                </div>
              </div>

              <!-- Edit Form -->
              <div class="expanded-form-section md:w-6 w-full">
                <div class="surface-card p-4 border-round shadow-1">
                  <h3 class="mt-0 mb-3 text-900">Edit Details</h3>

                  <div class="field mb-3">
                    <label for="title" class="font-bold block mb-2 text-700">Title</label>
                    <input pInputText id="title" [(ngModel)]="editingPhoto.title" class="w-full" />
                  </div>

                  <div class="field mb-3">
                    <label for="description" class="font-bold block mb-2 text-700">Description</label>
                    <textarea pTextarea id="description" [(ngModel)]="editingPhoto.description" rows="3"
                      class="w-full"></textarea>
                  </div>

                  <div class="formgrid grid">
                    <div class="field col-12 md:col-6 mb-3">
                      <label for="date" class="font-bold block mb-2 text-700">Date</label>
                      <p-datepicker [(ngModel)]="editingPhoto.dateObj" [showTime]="true" dateFormat="yy-mm-dd"
                        appendTo="body" styleClass="w-full" [style]="{'width':'100%'}" [title]="'Date'"></p-datepicker>
                    </div>
                    <div class="field col-12 md:col-6 mb-3">
                      <label class="font-bold block mb-2 text-700">Categories</label>
                      <p-multiSelect [options]="categories()" [(ngModel)]="editingPhoto.categoryIds" optionLabel="categoryName"
                        optionValue="id" display="chip" [style]="{'width':'100%'}" appendTo="body"></p-multiSelect>
                    </div>
                  </div>

                  <div class="field mb-3">
                    <label class="font-bold block mb-2 text-700">Location</label>
                    <div class="formgrid grid">
                      <div class="field col-12 md:col-10 mb-2">
                        <p-select [options]="reusableLocations()" optionLabel="name" optionValue="id"
                          [(ngModel)]="editingPhoto.locationId"
                          (onChange)="onReusableLocationSelect(photo.id, $event.value)"
                          placeholder="Select existing location" [showClear]="true" [style]="{'width':'100%'}"
                          appendTo="body"></p-select>
                      </div>

                      <div class="field col-12 md:col-2 mb-2">
                        <button pButton icon="pi pi-map" (click)="openMapSelector(photo)" pTooltip="Select on Map"
                          class="p-button-secondary"></button>
                      </div>
                    </div>
                  </div>

                  <div class="field-checkbox mb-4">
                    <p-checkbox [(ngModel)]="editingPhoto.isPrivacyProtected" [binary]="true"
                      inputId="privacy"></p-checkbox>
                    <label for="privacy" class="ml-2 text-700">Privacy Protected</label>
                  </div>

                  <div class="flex justify-content-end gap-2">
                    <p-button label="Cancel" icon="pi pi-times" severity="secondary"
                      (onClick)="onRowEditCancel(photo)"></p-button>
                    <p-button label="Save Changes" icon="pi pi-check" (onClick)="onRowEditSave(photo)"></p-button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          }
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="8" class="text-center p-4">
          <div class="empty-state">
            <i class="pi pi-images"></i>
            <p>No photos loaded. Select a directory or load from server.</p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>